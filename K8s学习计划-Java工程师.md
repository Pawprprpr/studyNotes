â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Control Plane (Master Node)             â”‚                         Worker Nodes                        â”‚
â”‚                                                                 â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   API       â”‚    â”‚  Scheduler  â”‚    â”‚ Controller  â”‚        â”‚  â”‚    kubelet  â”‚    â”‚  kube-proxy â”‚    â”‚  Container  â”‚     â”‚
â”‚  â”‚   Server    â”‚â—„â”€â”€â”€â”‚             â”‚â—„â”€â”€â”€â”‚  Manager    â”‚        â”‚  â”‚             â”‚    â”‚             â”‚    â”‚  Runtime    â”‚     â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚        â”‚  â”‚             â”‚    â”‚             â”‚    â”‚ (Docker/    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚  containerd)â”‚     â”‚
â”‚         â”‚                  â”‚                  â”‚               â”‚         â”‚                  â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                            â”‚                                  â”‚                            â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             etcd Cluster                   â”‚               â”‚  â”‚                  Pods                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”               â”‚               â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚Node â”‚   â”‚Pod  â”‚   â”‚Configâ”‚               â”‚               â”‚  â”‚  â”‚App  â”‚  â”‚Side-â”‚  â”‚App  â”‚  â”‚App  â”‚  â”‚Init â”‚      â”‚   â”‚
â”‚  â”‚  â”‚Info â”‚   â”‚Info â”‚   â”‚Maps  â”‚               â”‚               â”‚  â”‚  â”‚Cont â”‚  â”‚car  â”‚  â”‚Cont â”‚  â”‚Cont â”‚  â”‚Cont â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”˜               â”‚               â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                â–²                                                                 â–²
                                â”‚                                                                 â”‚
                                â”‚                                                                 â”‚
                          kubectl / API                                                    Workloads
                           Commands                                                      (Deployments, etc.)


cubectlå‘½ä»¤å¤§å…¨
https://kubernetes.io/zh-cn/docs/reference/kubectl/
å¸¸ç”¨å¦‚ä¸‹
ä½¿ç”¨ kubectl create å‘½ä»¤åˆ›å»ºç®¡ç† Pod çš„ Deploymentã€‚è¯¥ Pod æ ¹æ®æä¾›çš„ Docker é•œåƒè¿è¡Œå®¹å™¨ã€‚

# è¿è¡ŒåŒ…å« Web æœåŠ¡å™¨çš„æµ‹è¯•å®¹å™¨é•œåƒ
kubectl create deployment hello-node --image=registry.k8s.io/e2e-test-images/agnhost:2.53 -- /agnhost netexec --http-port=8080
æŸ¥çœ‹ Deploymentï¼š

kubectl get deployments
è¾“å‡ºç»“æœç±»ä¼¼äºè¿™æ ·ï¼š

NAME         READY   UP-TO-DATE   AVAILABLE   AGE
hello-node   1/1     1            1           1m
ï¼ˆè¯¥ Pod å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½å˜å¾—å¯ç”¨ã€‚å¦‚æœä½ åœ¨è¾“å‡ºç»“æœä¸­çœ‹åˆ° â€œ0/1â€ï¼Œè¯·åœ¨å‡ ç§’é’Ÿåé‡è¯•ã€‚ï¼‰

æŸ¥çœ‹ Podï¼š

kubectl get pods
è¾“å‡ºç»“æœç±»ä¼¼äºè¿™æ ·ï¼š

NAME                          READY     STATUS    RESTARTS   AGE
hello-node-5f76cf6ccf-br9b5   1/1       Running   0          1m
æŸ¥çœ‹é›†ç¾¤äº‹ä»¶ï¼š

kubectl get events
æŸ¥çœ‹ kubectl é…ç½®ï¼š

kubectl config view
æŸ¥çœ‹ Pod ä¸­å®¹å™¨çš„åº”ç”¨ç¨‹åºæ—¥å¿—ï¼ˆå°† Pod åç§°æ›¿æ¢ä¸ºä½ ç”¨ kubectl get pods å‘½ä»¤è·å¾—çš„åç§°ï¼‰ã€‚

è¯´æ˜ï¼š
å°† kubectl logs å‘½ä»¤ä¸­çš„ hello-node-5f76cf6ccf-br9b5 æ›¿æ¢ä¸º kubectl get pods å‘½ä»¤è¾“å‡ºä¸­çš„ Pod åç§°ã€‚

kubectl logs hello-node-5f76cf6ccf-br9b5
è¾“å‡ºç±»ä¼¼äºï¼š

I0911 09:19:26.677397       1 log.go:195] Started HTTP server on port 8080
I0911 09:19:26.677586       1 log.go:195] Started UDP server on port  8081


-------------------------------
ğŸ“Œ ä¸€å¥è¯è®°ä½
ConfigMap = K8sçš„é…ç½®æ–‡ä»¶ä¸­å¿ƒï¼ŒæŠŠé…ç½®å’Œé•œåƒåˆ†å¼€ã€‚

ğŸ”§ åˆ›å»ºConfigMapï¼ˆ3ç§æ–¹å¼ï¼Œè®°å‰2ç§ï¼‰
bash
# 1. ä»é”®å€¼å¯¹ï¼ˆç®€å•é…ç½®ï¼‰
kubectl create configmap app-config --from-literal=env=prod

# 2. ä»æ–‡ä»¶ï¼ˆæ¨èï¼ŒJavaé…ç½®æ–‡ä»¶ï¼‰
kubectl create configmap app-config --from-file=application.yml
ğŸš€ åœ¨Deploymentä¸­ä½¿ç”¨ï¼ˆ2ç§æ–¹å¼ï¼‰
æ–¹å¼1ï¼šç¯å¢ƒå˜é‡ï¼ˆè¿æ¥ä¿¡æ¯ç”¨ï¼‰
yaml
env:
- name: DB_URL
  valueFrom:
    configMapKeyRef:
      name: app-config      # ConfigMapåå­—
      key: db.url           # é‡Œé¢çš„key
æ–¹å¼2ï¼šæ–‡ä»¶æŒ‚è½½ï¼ˆé…ç½®æ–‡ä»¶ç”¨ï¼Œæœ€å¸¸ç”¨ï¼‰
yaml
# å…³é”®å¯¹åº”å…³ç³»ï¼š
# volumeMounts.name = volumes.name
# volumes.configMap.name = ConfigMapåå­—

containers:
- volumeMounts:
  - name: config          # æŒ‚è½½ç‚¹å
    mountPath: /app/config  # æŒ‚å“ªé‡Œ
    
volumes:
- name: config            # åŒä¸Š
  configMap:
    name: app-config      # ConfigMapåå­—
ğŸ”„ æ›´æ–°æœºåˆ¶ï¼ˆé¢è¯•å¸¸é—®ï¼‰
æ–‡ä»¶æŒ‚è½½ï¼šæ”¹ConfigMap â†’ è‡ªåŠ¨æ›´æ–°æ–‡ä»¶ï¼ˆJavaåº”ç”¨å¯èƒ½éœ€è¦é‡å¯ï¼‰

ç¯å¢ƒå˜é‡ï¼šæ”¹ConfigMap â†’ å¿…é¡»é‡å¯Podæ‰ç”Ÿæ•ˆ

ç”Ÿäº§å»ºè®®ï¼šæ”¹é…ç½®åéƒ½é‡å¯ä¸€ä¸‹

bash
kubectl rollout restart deployment <åº”ç”¨å>
ğŸ’¡ Javaåº”ç”¨æœ€ä½³å®è·µ
yaml
# Spring Bootåº”ç”¨é…ç½®
containers:
- name: spring-app
  # 1. é…ç½®æ–‡ä»¶æŒ‚è½½
  volumeMounts:
  - name: config
    mountPath: /app/config
  
  # 2. å‘Šè¯‰Springå»å“ªè¯»
  command: ["java", "-jar", "app.jar",
           "--spring.config.location=file:/app/config/application.yml"]
  
volumes:
- name: config
  configMap:
    name: spring-config
âš ï¸ æ³¨æ„ç‚¹
å¤§å°é™åˆ¶ï¼š1MBï¼Œåˆ«æ”¾å¤§æ–‡ä»¶

æ•æ„Ÿæ•°æ®ï¼šå¯†ç ã€tokenç”¨Secretï¼Œåˆ«ç”¨ConfigMap

å¤šç¯å¢ƒï¼šåˆ›å»ºä¸åŒConfigMapï¼ˆdev-configã€prod-configï¼‰

ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤
bash
# æŸ¥çœ‹
kubectl get cm
kubectl describe cm <åå­—>

# ç¼–è¾‘
kubectl edit cm <åå­—>

# ä»YAMLæ–‡ä»¶
kubectl apply -f config.yaml
ğŸ¯ é¢è¯•è¦ç‚¹
æ˜¯ä»€ä¹ˆï¼šé…ç½®ç®¡ç†ä¸­å¿ƒ

æ€ä¹ˆç”¨ï¼šç¯å¢ƒå˜é‡ï¼ˆç®€å•å€¼ï¼‰ã€æ–‡ä»¶æŒ‚è½½ï¼ˆé…ç½®æ–‡ä»¶ï¼‰

æ›´æ–°åŒºåˆ«ï¼šæ–‡ä»¶è‡ªåŠ¨æ›´æ–°ï¼Œç¯å¢ƒå˜é‡è¦é‡å¯

å’ŒSecretåŒºåˆ«ï¼šConfigMapå­˜æ™®é€šé…ç½®ï¼ŒSecretå­˜æ•æ„Ÿæ•°æ®

ğŸ“ ä¸€å¥è¯å·¥ä½œè®°å¿†
Javaé¡¹ç›®ï¼šapplication.ymlæ”¾ConfigMapï¼ŒæŒ‚è½½åˆ°/app/configï¼ŒSpringä»è¿™è¯»ã€‚æ”¹é…ç½®åé‡å¯Deploymentæœ€ä¿é™©ã€‚

å¤Ÿäº†ï¼Œå°±è®°è¿™äº›ï¼ å·¥ä½œä¸­é‡åˆ°é—®é¢˜å†æŸ¥å…·ä½“ç»†èŠ‚ã€‚



